<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>LeeNDXloud ‚Äî Music ‚Ä¢ Web3 ‚Ä¢ Social (Cloudinary + Firebase)</title>
<meta name="description" content="LeeNDXloud ‚Äî single-file front-end with Firebase persistence, Google+Email auth, live CoinGecko prices, MetaMask & Freighter support, Cloudinary uploads." />

<!-- External libs -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
<script src="https://unpkg.com/@stellar/freighter-api@2.3.0/dist/index.umd.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg: linear-gradient(180deg, rgba(250,252,255,0.92), rgba(240,247,255,0.7));
    --panel: rgba(255,255,255,0.88);
    --glass-border: rgba(10,10,10,0.06);
    --muted: #6b7280;
    --accent: #0ea5e9;
    --accent-2: #ef4444;
    --accent-3: #6366f1;
    --max-width: 392px;
  }
  [data-theme="dark"]{
    --bg: linear-gradient(180deg,#071022,#061226);
    --panel: rgba(8,10,18,0.86);
    --glass-border: rgba(255,255,255,0.06);
    --muted:#9aa3b2;
    --accent:#3b82f6;
    --accent-2:#fb7185;
    --accent-3:#8b5cf6;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:var(--bg);-webkit-font-smoothing:antialiased}
  .app{max-width:var(--max-width);margin:0 auto;padding:8px;padding-bottom:120px;min-height:100vh}

  header{display:flex;align-items:center;gap:10px;padding:8px 6px;border-radius:12px;position:sticky;top:6px;background:transparent;z-index:60}
  .logo{display:flex;align-items:center;gap:10px;cursor:pointer}
  .logo .svg{width:56px;height:56px;border-radius:12px;padding:6px;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 14px 40px rgba(0,0,0,0.12);display:flex;align-items:center;justify-content:center}
  .brand{font-size:20px;font-weight:900;line-height:1;color:transparent;background:linear-gradient(90deg,rgba(255,255,255,0.95), rgba(255,255,255,0.6)), linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;background-clip:text; text-shadow: 0 4px 14px rgba(99,102,241,0.12)}
  .tag{font-size:11px;color:var(--muted);margin-top:2px}

  .top-actions{margin-left:auto;display:flex;gap:10px;align-items:center}
  .theme-logo{width:48px;height:48px;border-radius:999px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-2));box-shadow:0 10px 30px rgba(99,102,241,0.12);border:2px solid rgba(255,255,255,0.32)}

  .ticker-row{display:flex;gap:8px;align-items:center;margin-left:8px;overflow:auto}
  .coin-pill{padding:6px 8px;border-radius:999px;background:transparent;border:1px solid var(--glass-border);font-weight:700;min-width:86px;text-align:center;font-size:12px}

  .studio-card{background:var(--panel);border-radius:12px;padding:10px;border:1px solid var(--glass-border);backdrop-filter:blur(6px);margin-top:10px}
  .studio-row{display:flex;gap:10px;align-items:center}
  .rec-big{width:68px;height:68px;border-radius:18px;background:linear-gradient(90deg,var(--accent-3),var(--accent));color:white;border:none;font-weight:900;font-size:14px}
  .studio-controls{flex:1;display:flex;flex-direction:column;gap:8px}
  .pads{display:flex;gap:8px;flex-wrap:wrap}
  .pad{flex:1;padding:10px;border-radius:12px;text-align:center;font-weight:800;background:rgba(255,255,255,0.04);border:1px solid var(--glass-border);min-width:70px}

  .sessions{display:flex;gap:8px;overflow:auto;padding-top:8px}
  .session-pill{padding:8px 12px;border-radius:999px;border:1px solid var(--glass-border);background:transparent;font-weight:700;min-width:110px}

  .controls{display:flex;gap:8px;overflow:auto;padding:8px;margin-top:10px}
  .chip{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid var(--glass-border);font-weight:700;font-size:13px}

  .feed{display:grid;grid-template-columns:1fr;gap:12px;margin-top:8px}
  .card{background:var(--panel);border-radius:12px;padding:10px;border:1px solid var(--glass-border);backdrop-filter:blur(6px)}
  .media{height:320px;border-radius:12px;overflow:hidden;position:relative;background:linear-gradient(180deg,rgba(0,0,0,0.04),rgba(0,0,0,0.01))}
  .media img{width:100%;height:100%;object-fit:cover;display:block}

  .row{display:flex;align-items:center;gap:10px}
  .profile-pic{width:48px;height:48px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:18px}

  .actions{display:flex;gap:8px;margin-top:8px}
  .actions button{flex:1;padding:10px;border-radius:10px;border:none;background:transparent;font-weight:700}

  .home-page{animation:fadeIn .22s ease}
  .hero{background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.35));border-radius:12px;padding:12px;display:flex;gap:12px;align-items:center}
  .hero h2{margin:0;font-size:18px}
  .cards-row{display:flex;gap:10px;overflow:auto;padding-top:10px}
  .home-card{min-width:152px;padding:12px;border-radius:12px;border:1px solid var(--glass-border);background:var(--panel);font-weight:800}

  .dashboard-page{animation:fadeIn .22s ease}
  .dash-top{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .balance-card{background:linear-gradient(90deg,var(--accent),var(--accent-3));color:#fff;padding:12px;border-radius:12px;min-width:160px}
  .stat-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px}
  .stat-card{background:var(--panel);padding:10px;border-radius:10px;border:1px solid var(--glass-border)}
  .chart-wrap{margin-top:12px;background:var(--panel);padding:8px;border-radius:12px;border:1px solid var(--glass-border)}

  .bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;width:calc(100% - 28px);max-width:var(--max-width);background:var(--panel);border-radius:18px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 12px 40px rgba(2,6,23,0.12);border:1px solid var(--glass-border);z-index:90}
  .big-create{background:linear-gradient(90deg,var(--accent-3),var(--accent));color:white;padding:10px 12px;border-radius:12px;font-weight:900;font-size:14px}

  .modal-bg{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:200}
  .modal{width:100%;max-width:420px;border-radius:12px;padding:12px;background:var(--panel);border:1px solid var(--glass-border);max-height:90vh;overflow:auto;position:relative}
  .modal .close-x{position:absolute;right:14px;top:14px;font-size:18px;cursor:pointer}
  .toast{position:fixed;right:16px;bottom:96px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(2,6,23,0.18);display:none;z-index:400}

  input,select,textarea{padding:10px;border-radius:10px;border:1px solid var(--glass-border);width:100%}
  button.btn{padding:10px 12px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent-3),var(--accent));color:white;font-weight:800}

  .small{font-size:12px}
  .muted{color:var(--muted)}
  @media(min-width:720px){ .feed{grid-template-columns:repeat(2,1fr)} .media{height:220px} }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px) } to { opacity: 1; transform: translateY(0) } }

  /* Option B wallet list styling (white translucent rows) */
  .wallet-list { display:flex;flex-direction:column;gap:8px;margin-top:10px }
  .wallet-row { display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;background: rgba(255,255,255,0.92);box-shadow: 0 6px 18px rgba(6,10,20,0.06);border:1px solid var(--glass-border);cursor:pointer }
  .wallet-row .icon { width:40px;height:40px;border-radius:8px;background:linear-gradient(90deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800; }
  .wallet-row .meta { flex:1 }
  .wallet-row .meta .title { font-weight:800 }
  .wallet-row .meta .subtitle { font-size:12px;color:var(--muted);margin-top:2px }
  .wallet-recommended { font-size:12px;color:var(--accent);font-weight:900;margin-left:6px }
  .wallet-actions { display:flex;gap:8px;margin-top:10px }

  /* upload progress bar */
  .progress { height:8px;background:rgba(0,0,0,0.06);border-radius:8px;overflow:hidden }
  .progress > i { display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .12s linear }
</style>
</head>
<body data-theme="light">
  <div class="app" id="app">

    <!-- HEADER -->
    <header>
      <div class="logo" onclick="showHome()">
        <div class="svg" aria-hidden="true">
          <svg viewBox="0 0 64 64" width="44" height="44" xmlns="http://www.w3.org/2000/svg">
            <defs><linearGradient id="lg" x1="0" x2="1"><stop offset="0" stop-color="#0ea5e9"/><stop offset="1" stop-color="#ef4444"/></linearGradient></defs>
            <rect rx="12" width="64" height="64" fill="url(#lg)"/>
            <path d="M18 42c6-8 18-14 28-10-8-8-16-6-26 2 2 4 0 8-2 8z" fill="rgba(255,255,255,0.95)"/>
            <circle cx="46" cy="18" r="6" fill="white"/>
          </svg>
        </div>
        <div>
          <div class="brand">LeeNDXloud</div>
          <div class="tag muted">Music √ó Web3 ‚Ä¢ Earn XLM</div>
        </div>
      </div>

      <div id="tickRow" class="ticker-row" aria-hidden="false" style="margin-left:8px"></div>

      <div class="top-actions">
        <div id="uniqueThemeToggle" class="theme-logo" title="Toggle theme"></div>
        <button class="chip" id="loginBtn">Login</button>
        <button class="chip" id="connectWalletTop">Connect Wallet</button>
      </div>
    </header>

    <!-- STUDIO (top) -->
    <section class="studio-card" id="studioCard" aria-label="Studio">
      <div class="studio-row">
        <button id="recBtn" class="rec-big" title="Record">REC</button>
        <div class="studio-controls">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>Studio</strong><div class="small muted">Record, preview, and save sessions</div>
            </div>
            <div class="small muted">Session: <span id="sessionTimer">0:00</span></div>
          </div>

          <div class="pads" style="margin-top:8px">
            <div class="pad" data-pad="kick">Kick</div>
            <div class="pad" data-pad="snare">Snare</div>
            <div class="pad" data-pad="hihat">HiHat</div>
            <div class="pad" data-pad="synth">Synth</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
            <button id="playLast" class="chip">Play Last</button>
            <button id="saveTake" class="chip" style="display:none">Save Session</button>
            <button id="openSessions" class="chip">Saved Sessions</button>
            <div style="flex:1"></div>
            <button id="createBtnTop" class="big-create">+ Create</button>
          </div>

          <div class="sessions" id="sessionsRow" style="margin-top:8px"></div>
        </div>
      </div>

      <audio id="studioPreview" controls style="width:100%;margin-top:10px;display:none"></audio>
    </section>

    <div class="controls">
      <button class="chip" onclick="renderFeed('for-you')">For you</button>
      <button class="chip" onclick="renderFeed('trending')">üî• Trends</button>
      <button class="chip" onclick="renderFeed('hots')">Hots</button>
      <button class="chip" onclick="openModal('market')">Marketplace</button>
      <div style="flex:1"></div>
      <div class="small muted">Prices ‚Ä¢ <span id="priceTicker">Loading‚Ä¶</span></div>
    </div>

    <main id="mainView" style="margin-top:10px">
      <div id="feedView" class="feed" role="main"></div>
    </main>

    <nav class="bottom-nav" role="navigation">
      <div style="display:flex;gap:8px;align-items:center">
        <button class="chip" onclick="showHome()"><strong>Home</strong></button>
        <button class="chip" onclick="openModal('p2p')">P2P</button>
        <button class="chip" onclick="openModal('activities')">Activity</button>
      </div>

      <button id="createBtnBottom" class="big-create" onclick="openModal('create')">Create</button>

      <div style="display:flex;gap:8px;align-items:center">
        <button class="chip" id="walletBtnBottom" onclick="openModal('wallet')">Wallet</button>
        <button class="chip" onclick="showDashboard()">Dashboard</button>
        <button class="chip" onclick="openModal('settings')">Me</button>
      </div>
    </nav>

    <div id="modalBg" class="modal-bg" onclick="closeModal(event)">
      <div id="modal" class="modal" onclick="event.stopPropagation()"></div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

<script>
/* =========================
   FIREBASE CONFIG (user provided)
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyC1OmTwIKpiTbOXLrsiUmz2oqgibPmiIWM",
  authDomain: "leendxloud-6603a.firebaseapp.com",
  projectId: "leendxloud-6603a",
  storageBucket: "leendxloud-6603a.firebasestorage.app",
  messagingSenderId: "699725496153",
  appId: "1:699725496153:web:685e2267cb1a82f7f79648",
  measurementId: "G-19QRH13HZN"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* =========================
   CLOUDINARY PUBLIC SETTINGS (unsigned preset)
   - Provided by you; used client-side only
   ========================= */
const CLOUDINARY = {
  cloud_name: "djdxlctpt",
  upload_preset: "leendxloud_unsigned",
  url: "https://api.cloudinary.com/v1_1/djdxlctpt/auto/upload",
  maxBytes: 100 * 1024 * 1024 // 100 MB
};

/* =========================
   App state + helpers
   ========================= */
const app = {
  coinsOrder: ['bitcoin','ethereum','binancecoin','solana','tron','tether','stellar'],
  coinSymbols: { bitcoin:'BTC', ethereum:'ETH', binancecoin:'BNB', solana:'SOL', tron:'TRX', tether:'USDT', stellar:'XLM' },
  prices:{}, view:'feed', ethProvider:null, freighter:null, connectedType:null,
  currentUser:null, savedSessionsLocal: JSON.parse(localStorage.getItem('leendx_sessions')||'[]')
};
const $ = s => document.querySelector(s), $$ = s => Array.from(document.querySelectorAll(s));
const toast = (m,t=2400)=>{ const T=$('#toast'); T.innerText=m; T.style.display='block'; setTimeout(()=>T.style.display='none',t); };

/* =========================
   AUTH UI & flows (Email/Password & Google)
   ========================= */
function mkLoginModal(){
  return `
    <div class="close-x" onclick="closeModal()">√ó</div>
    <h3>Login</h3>
    <div style="display:grid;gap:8px;margin-top:8px">
      <input id="li_email" placeholder="Email" />
      <input id="li_pass" placeholder="Password" type="password" />
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="doLogin()">Login</button>
        <button class="chip" onclick="closeModal()">Cancel</button>
      </div>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="chip" onclick="openModal('register')">Register</button>
        <button class="chip" onclick="doGoogleSignIn()">Continue with Google</button>
      </div>
      <div style="margin-top:8px"><a href='#' onclick="openModal('reset')">Forgot password?</a></div>
    </div>
  `;
}
function mkRegisterModal(){
  return `
    <div class="close-x" onclick="closeModal()">√ó</div>
    <h3>Create account</h3>
    <div style="display:grid;gap:8px;margin-top:8px">
      <input id="rg_name" placeholder="Full name" />
      <input id="rg_username" placeholder="Username" />
      <input id="rg_email" placeholder="Email" />
      <input id="rg_pass" placeholder="Password" type="password" />
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="doRegister()">Register</button>
        <button class="chip" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  `;
}
function mkResetModal(){
  return `
    <div class="close-x" onclick="closeModal()">√ó</div>
    <h3>Reset password</h3>
    <div style="display:grid;gap:8px;margin-top:8px">
      <input id="reset_email" placeholder="Email" />
      <div style="display:flex;gap:8px">
        <button class="btn" onclick="doReset()">Send reset email</button>
        <button class="chip" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  `;
}

async function doLogin(){
  const email = ($('#li_email')?.value||'').trim();
  const pass = $('#li_pass')?.value||'';
  if(!email||!pass) return toast('Enter email and password');
  try{
    const cred = await auth.signInWithEmailAndPassword(email, pass);
    app.currentUser = cred.user;
    await ensureUserDoc(cred.user);
    closeModal();
    toast('Signed in');
    updateAuthUI();
  }catch(e){ console.error(e); toast('Login failed: '+(e.message||e.code)); }
}
async function doRegister(){
  const name = ($('#rg_name')?.value||'').trim();
  const username = ($('#rg_username')?.value||'').trim();
  const email = ($('#rg_email')?.value||'').trim();
  const pass = ($('#rg_pass')?.value||'')||'';
  if(!name||!username||!email||!pass) return toast('Fill all fields');
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await cred.user.updateProfile({ displayName: name });
    await db.collection('users').doc(cred.user.uid).set({ name, username, email, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    app.currentUser = cred.user;
    closeModal();
    toast('Account created');
    updateAuthUI();
  }catch(e){ console.error(e); toast('Register failed: '+(e.message||e.code)); }
}
async function doGoogleSignIn(){
  const provider = new firebase.auth.GoogleAuthProvider();
  try{
    const result = await auth.signInWithPopup(provider);
    app.currentUser = result.user;
    await ensureUserDoc(result.user);
    closeModal();
    toast('Signed in with Google');
    updateAuthUI();
  }catch(e){ console.error(e); toast('Google sign-in failed'); }
}
async function doReset(){
  const email = ($('#reset_email')?.value||'').trim();
  if(!email) return toast('Enter email');
  try{ await auth.sendPasswordResetEmail(email); toast('Reset email sent'); closeModal(); }catch(e){ console.error(e); toast('Reset failed'); }
}
async function ensureUserDoc(user){
  if(!user) return;
  const ref = db.collection('users').doc(user.uid);
  const snap = await ref.get();
  if(!snap.exists) await ref.set({ name: user.displayName||'', email: user.email||'', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
}

/* auth state listener */
auth.onAuthStateChanged(async user => {
  app.currentUser = user;
  updateAuthUI();
  if(user) startRealtimeListeners();
  else { app.feed = []; seedFeed(); renderFeed(); stopRealtimeListeners(); }
});
function updateAuthUI(){ if(app.currentUser) $('#loginBtn').innerText = app.currentUser.displayName ? ('Hi '+ app.currentUser.displayName.split(' ')[0]) : 'Hi'; else $('#loginBtn').innerText = 'Login'; }

/* =========================
   Firestore realtime feed & sessions
   ========================= */
app.feed = [];
let postsUnsub=null, sessionsUnsub=null;
function startRealtimeListeners(){
  if(postsUnsub) return;
  postsUnsub = db.collection('posts').orderBy('ts','desc').limit(200).onSnapshot(snap=>{
    const items=[];
    snap.forEach(doc=>{ const d=doc.data(); d.id=doc.id; items.push(d); });
    app.feed = items;
    if(app.view==='feed' || app.view==='home') renderFeed();
  }, err=>console.error('posts snapshot', err));
  sessionsUnsub = db.collection('sessions').orderBy('ts','desc').limit(200).onSnapshot(snap=>{
    const ss=[];
    snap.forEach(doc=>{ const d = Object.assign({id:doc.id}, doc.data()); ss.push(d); });
    app.savedSessionsLocal = ss;
    localStorage.setItem('leendx_sessions', JSON.stringify(ss));
    renderSessions();
  }, err=>console.error('sessions snapshot', err));
}
function stopRealtimeListeners(){ if(postsUnsub){ postsUnsub(); postsUnsub=null;} if(sessionsUnsub){ sessionsUnsub(); sessionsUnsub=null; }}

/* =========================
   CLOUDINARY upload: blob -> Cloudinary -> Firestore session + optional post
   - uses unsigned upload preset (no secret)
   - progress via XMLHttpRequest
   ========================= */
async function uploadToCloudinary(fileBlob, fileName, onProgress){
  return new Promise((resolve, reject) => {
    try{
      const fd = new FormData();
      fd.append('file', fileBlob, fileName || ('upload_'+Date.now()));
      fd.append('upload_preset', CLOUDINARY.upload_preset);
      // optionally pass folder or tags
      fd.append('folder', `leendxloud/sessions/`);
      const xhr = new XMLHttpRequest();
      xhr.open('POST', CLOUDINARY.url, true);
      xhr.upload.onprogress = function(e){
        if(e.lengthComputable && typeof onProgress === 'function'){
          onProgress(e.loaded, e.total);
        }
      };
      xhr.onload = function(){
        if(xhr.status >= 200 && xhr.status < 300){
          try{
            const res = JSON.parse(xhr.responseText);
            resolve(res);
          }catch(err){
            reject(new Error('Invalid Cloudinary response'));
          }
        } else {
          reject(new Error('Upload failed: ' + xhr.status + ' ' + xhr.statusText));
        }
      };
      xhr.onerror = function(){ reject(new Error('Network error during upload')); };
      xhr.send(fd);
    }catch(e){ reject(e); }
  });
}

async function uploadRecordingAndPost(blob, title = 'Recorded Session', postToFeed=true){
  if(!app.currentUser) { toast('Sign in to upload'); return; }
  if(!blob) return toast('No recording to upload');
  // blob size check
  const size = blob.size || (blob.length || 0);
  if(size > CLOUDINARY.maxBytes) return toast('File too large (max 100 MB)');
  // show upload progress modal
  openUploadProgress('Uploading to Cloudinary...');
  try{
    const res = await uploadToCloudinary(blob, `session_${Date.now()}`, (loaded, total) => {
      const pct = Math.round((loaded/total)*100);
      const bar = document.querySelector('.progress > i');
      if(bar) bar.style.width = pct + '%';
    });
    // Cloudinary returned secure_url
    const secureUrl = res.secure_url || res.url;
    if(!secureUrl) throw new Error('No URL from Cloudinary');
    // create session doc
    const sessionDoc = {
      uid: app.currentUser.uid,
      url: secureUrl,
      public_id: res.public_id || null,
      format: res.format || null,
      bytes: res.bytes || size,
      ts: firebase.firestore.FieldValue.serverTimestamp(),
      mime: res.resource_type || 'auto',
      ownerName: app.currentUser.displayName || app.currentUser.email || 'User'
    };
    const sessionRef = await db.collection('sessions').add(sessionDoc);
    // optionally create a post referencing this session
    if(postToFeed){
      const postDoc = {
        user: app.currentUser.displayName || app.currentUser.email || 'User',
        title,
        image: res.secure_url && res.resource_type && res.resource_type.startsWith('video') ? (res.secure_url) : (`https://picsum.photos/seed/${Math.floor(Math.random()*99999)}/800/640`),
        audio: res.secure_url,
        likes: 0,
        xlm: 0,
        minted: false,
        uid: app.currentUser.uid,
        ts: firebase.firestore.FieldValue.serverTimestamp()
      };
      await db.collection('posts').add(postDoc);
    }
    closeModal();
    toast('Upload complete and posted to feed');
  }catch(e){
    console.error('upload error', e);
    closeModal();
    toast('Upload failed: ' + (e.message || 'unknown'));
  }
}

/* upload progress modal helpers */
function openUploadProgress(msg='Uploading...'){
  modalBg.style.display='flex';
  modal.innerHTML = `<div class="close-x" onclick="closeModal()">√ó</div><h3>${msg}</h3><div class="progress" style="margin-top:12px"><i style="width:0%"></i></div><div style="display:flex;gap:8px;margin-top:10px"><button class="chip" onclick="closeModal()">Cancel</button></div>`;
}
function closeUploadProgress(){ closeModal(); }

/* =========================
   Wallet modal (EVM list + Freighter) & connect/disconnect logic
   ========================= */
function mkWalletModal(){
  return `
    <div class="close-x" onclick="closeModal()">√ó</div>
    <h3>Connect Wallet</h3>
    <div class="small muted">Choose a wallet to connect. MetaMask is recommended.</div>
    <div class="wallet-list" style="margin-top:12px">
      <div class="wallet-row" onclick="connectEVMWallet('metamask')">
        <div class="icon">MM</div>
        <div class="meta"><div class="title">MetaMask <span class="wallet-recommended">recommended</span></div><div class="subtitle">Browser & mobile MetaMask</div></div>
      </div>
      <div class="wallet-row" onclick="connectEVMWallet('coinbase')">
        <div class="icon">CB</div>
        <div class="meta"><div class="title">Coinbase Wallet</div><div class="subtitle">Coinbase mobile/browser</div></div>
      </div>
      <div class="wallet-row" onclick="connectEVMWallet('brave')">
        <div class="icon">BR</div>
        <div class="meta"><div class="title">Brave Wallet</div><div class="subtitle">Built-into Brave browser</div></div>
      </div>
      <div class="wallet-row" onclick="connectEVMWallet('trust')">
        <div class="icon">TW</div>
        <div class="meta"><div class="title">Trust Wallet</div><div class="subtitle">Mobile wallets (injected)</div></div>
      </div>
      <div class="wallet-row" onclick="connectEVMWallet('okx')">
        <div class="icon">OK</div>
        <div class="meta"><div class="title">OKX Wallet</div><div class="subtitle">OKX mobile/browser wallet</div></div>
      </div>

      <div style="height:6px"></div>
      <div class="wallet-row" onclick="connectFreighter()">
        <div class="icon">XL</div>
        <div class="meta"><div class="title">Freighter</div><div class="subtitle">Stellar wallet</div></div>
      </div>
    </div>

    <div class="wallet-actions">
      <button class="chip" onclick="disconnectWallet()">Disconnect Wallet</button>
      <button class="chip" onclick="closeModal()">Cancel</button>
    </div>

    <div id="walletInfo" style="margin-top:12px" class="small muted"></div>
  `;
}

/* EVM connect: supports multiple injected providers; metaMask recommended */
async function connectEVMWallet(walletType){
  try{
    if(!window.ethereum){
      toast('No EVM wallet detected. Install MetaMask (recommended).');
      return;
    }
    let targetProvider = window.ethereum;
    if(window.ethereum.providers && Array.isArray(window.ethereum.providers)){
      const providers = window.ethereum.providers;
      const match = providers.find(p => {
        if(walletType==='metamask' && p.isMetaMask) return true;
        if(walletType==='coinbase' && p.isCoinbaseWallet) return true;
        if(walletType==='brave' && p.isBraveWallet) return true;
        if(walletType==='trust' && p.isTrust) return true;
        if(walletType==='okx' && p.isOKXWallet) return true;
        return false;
      });
      if(match) targetProvider = match;
    } else {
      targetProvider = window.ethereum;
    }

    const accounts = await targetProvider.request({ method: 'eth_requestAccounts' });
    if(!accounts || !accounts[0]) return toast('Connection rejected or no accounts');
    const address = accounts[0];
    app.ethProvider = new ethers.providers.Web3Provider(targetProvider);
    app.connectedType = 'evm';
    app.user = app.user || {};
    app.user.wallet = address;
    app.user.walletProvider = walletType;
    const balWei = await app.ethProvider.getBalance(address);
    const ethBal = Number(ethers.formatEther(balWei));
    app.user.ethBalance = ethBal;
    $('#walletInfo').innerText = `${capitalize(walletType)}: ${address.slice(0,8)}... ‚Ä¢ ${ethBal.toFixed(6)} ETH`;
    localStorage.setItem('leendx_wallet_type','evm');
    localStorage.setItem('leendx_wallet_provider',walletType);
    if(app.currentUser) db.collection('users').doc(app.currentUser.uid).set({ wallet: address, walletProvider: walletType }, { merge:true }).catch(e=>console.warn('save wallet', e));
    closeModal();
    toast(`${capitalize(walletType)} connected`);
    scheduleConnectedBalanceRefresh();
    refreshConnectedBalances();
  }catch(e){ console.error('connectEVMWallet', e); toast('EVM connect failed'); }
}

/* retry silent reconnect for EVM */
async function tryReconnectEVM(){
  try{
    if(!window.ethereum) return;
    const last = localStorage.getItem('leendx_wallet_type');
    if(last !== 'evm') return;
    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
    if(accounts && accounts[0]){
      app.user = app.user || {};
      app.user.wallet = accounts[0];
      app.connectedType = 'evm';
      app.ethProvider = new ethers.providers.Web3Provider(window.ethereum);
      const bal = await app.ethProvider.getBalance(accounts[0]);
      app.user.ethBalance = Number(ethers.formatEther(bal));
      toast('EVM wallet reconnected');
      refreshConnectedBalances();
      scheduleConnectedBalanceRefresh();
    }
  }catch(e){ console.warn('evm reconnect', e); }
}

/* Freighter connect */
async function connectFreighter(){
  try{
    if(!window.freighterApi){
      toast('Freighter not available');
      return;
    }
    const freighter = new window.freighterApi.FreighterApi();
    const pubKey = await freighter.getPublicKey();
    app.freighter = freighter;
    app.connectedType = 'freighter';
    app.user = app.user || {};
    app.user.wallet = pubKey;
    localStorage.setItem('leendx_wallet_type','freighter');
    localStorage.setItem('leendx_wallet_provider','freighter');
    if(app.currentUser) db.collection('users').doc(app.currentUser.uid).set({ wallet: pubKey, walletProvider: 'freighter' }, { merge:true }).catch(e=>console.warn('save wallet', e));
    $('#walletInfo').innerText = `Freighter: ${pubKey.slice(0,8)}...`;
    closeModal();
    toast('Freighter connected');
    app.user.xlmBalance = await fetchXlmBalance(pubKey);
    scheduleConnectedBalanceRefresh();
    refreshConnectedBalances();
  }catch(e){ console.error('freighter', e); toast('Freighter connection failed'); }
}

/* try reconnect freighter */
async function tryReconnectFreighter(){
  try{
    const last = localStorage.getItem('leendx_wallet_type');
    if(last !== 'freighter') return;
    if(!window.freighterApi) return;
    const freighter = new window.freighterApi.FreighterApi();
    const pub = await freighter.getPublicKey().catch(()=>null);
    if(pub){ app.freighter = freighter; app.connectedType='freighter'; app.user = app.user || {}; app.user.wallet = pub; app.user.xlmBalance = await fetchXlmBalance(pub); toast('Freighter reconnected'); refreshConnectedBalances(); scheduleConnectedBalanceRefresh(); }
  }catch(e){ console.warn('freighter reconnect', e); }
}

/* Disconnect wallet */
async function disconnectWallet(){
  try{
    localStorage.removeItem('leendx_wallet_type');
    localStorage.removeItem('leendx_wallet_provider');
    if(app.connectedType === 'evm' && app.ethProvider && app.ethProvider.provider && app.ethProvider.provider.disconnect){
      try{ await app.ethProvider.provider.disconnect(); }catch(e){/* ignore */ }
    }
    app.ethProvider = null; app.freighter = null; app.connectedType = null;
    if(app.user){ delete app.user.wallet; delete app.user.walletProvider; delete app.user.ethBalance; delete app.user.xlmBalance; }
    $('#walletInfo').innerText = 'Disconnected';
    toast('Wallet disconnected');
    refreshConnectedBalances();
  }catch(e){ console.warn('disconnect', e); toast('Disconnect failed'); }
}

/* =========================
   Balances helpers
   ========================= */
async function fetchXlmBalance(publicKey){
  try{
    const res = await fetch(`https://horizon.stellar.org/accounts/${publicKey}`);
    if(!res.ok) return 0;
    const j = await res.json();
    const native = j.balances.find(b=>b.asset_type==='native');
    return native ? Number(native.balance) : 0;
  }catch(e){ console.warn('xlm balance', e); return 0; }
}
async function fetchEthBalanceFor(address){
  try{
    let provider = app.ethProvider;
    if(!provider) provider = new ethers.JsonRpcProvider('https://cloudflare-eth.com');
    const b = await provider.getBalance(address);
    return Number(ethers.formatEther(b));
  }catch(e){ console.warn('eth balance', e); return 0; }
}
async function refreshConnectedBalances(){
  const el = document.getElementById('connectedBalances');
  if(!el) return;
  if(!app.user || !app.user.wallet) { el.innerText = 'Not connected'; return; }
  let lines = [];
  if(app.connectedType === 'evm'){
    const address = app.user.wallet;
    const eth = await fetchEthBalanceFor(address);
    lines.push(`ETH (${address.slice(0,8)}...): ${eth.toFixed(6)}`);
    if(app.user.xlmBalance !== undefined) lines.push(`XLM: ${Number(app.user.xlmBalance).toFixed(6)}`);
  } else if(app.connectedType === 'freighter'){
    const pk = app.user.wallet;
    const xlm = await fetchXlmBalance(pk);
    lines.push(`XLM (${pk.slice(0,8)}...): ${Number(xlm).toFixed(6)}`);
  } else lines.push('No connected wallets');
  el.innerHTML = lines.map(l=>`<div>${l}</div>`).join('');
}
let balanceTimer = null;
function scheduleConnectedBalanceRefresh(){
  if(balanceTimer) clearInterval(balanceTimer);
  balanceTimer = setInterval(async ()=>{
    if(!app.user || !app.user.wallet) return;
    if(app.connectedType === 'freighter') app.user.xlmBalance = await fetchXlmBalance(app.user.wallet);
    else if(app.connectedType === 'evm') app.user.ethBalance = await fetchEthBalanceFor(app.user.wallet);
    refreshConnectedBalances();
  },30000);
}

/* =========================
   Feed render + seed
   ========================= */
function seedFeed(n=6){
  if(app.feed && app.feed.length) return;
  const creators = ['Ama','Kola','Seyi','Titi','DJ Blaze','Nia'];
  app.feed = [];
  for(let i=0;i<n;i++){
    app.feed.push({ id:'p'+(i+1), user:creators[i%creators.length], title:(i%2?'Freestyle':'Exclusive Beat')+' #'+(i+1), image:`https://picsum.photos/seed/ln${i+12}/800/640`, likes:Math.floor(Math.random()*9000), xlm:(Math.random()*5).toFixed(3), minted: Math.random()>0.6 });
  }
}
seedFeed();

function renderFeed(filter){
  app.view='feed';
  const main = $('#mainView'); main.innerHTML = `<div id="feedView" class="feed" role="main"></div>`;
  const feed = $('#feedView');
  let items = app.feed.slice();
  if(filter==='trending') items = items.filter(i=>i.likes>3000);
  if(filter==='hots') items = items.filter(i=>i.minted);
  items.forEach(p=>{
    const card = document.createElement('article'); card.className='card';
    card.innerHTML = `
      <div class="row">
        <div class="profile-pic">${(p.user||'U')[0]}</div>
        <div style="flex:1">
          <strong>${p.user||'Unknown'}</strong>
          <div class="small muted">${p.title||''} ‚Ä¢ ${p.minted? 'NFT':'Standard'}</div>
        </div>
        <div class="small muted">${p.likes || 0} ‚ù§</div>
      </div>
      <div class="media" role="button" tabindex="0" onclick="openModal('player','${p.id || ''}')">
        <img src="${p.image || 'https://picsum.photos/800/640'}" alt="${p.title||''}" />
        ${p.audio? `<audio controls style="position:absolute;left:10px;right:10px;bottom:10px;background:transparent" src="${p.audio}"></audio>` : `<div style="position:absolute;left:10px;bottom:10px;padding:6px 10px;border-radius:999px;background:rgba(0,0,0,0.45);color:white">Earned ${p.xlm || 0} XLM</div>`}
      </div>
      <div class="actions">
        <button onclick="gift('${p.id || ''}')">Gift</button>
        <button onclick="openModal('mint','${p.id || ''}')">Mint</button>
        <button onclick="openModal('buy','${p.id || ''}')">Buy</button>
      </div>
    `;
    feed.appendChild(card);
  });
}

/* =========================
   Home & Dashboard
   ========================= */
function renderHome(){
  app.view='home';
  const main = $('#mainView');
  main.innerHTML = `
    <div class="home-page">
      <div class="hero">
        <div style="flex:1">
          <h2>Welcome to LeeNDXloud üéß</h2>
          <div class="small muted">Exclusive music ‚Ä¢ NFTs ‚Ä¢ Community ‚Ä¢ Earn XLM</div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button class="big-create" onclick="renderFeed()">üéß Explore Music</button>
            <button class="chip" onclick="showDashboard()">üìä Dashboard</button>
          </div>
        </div>
        <div style="width:110px;text-align:center">
          <div style="width:86px;height:86px;border-radius:12px;background:linear-gradient(90deg,var(--accent),var(--accent-2));display:inline-block"></div>
        </div>
      </div>

      <h4 style="margin-top:12px">Top Creators</h4>
      <div class="cards-row" id="homeCreators"></div>

      <h4 style="margin-top:12px">Hot Beats</h4>
      <div class="cards-row" id="homeBeats"></div>

      <h4 style="margin-top:12px">Featured NFTs</h4>
      <div class="cards-row" id="homeNFTs"></div>

      <div style="margin-top:14px" class="card">
        <strong>Market Stats</strong>
        <div class="small muted" style="margin-top:6px">Live prices for major coins update every 15 seconds.</div>
        <div id="homeStats" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div>
      </div>

      <div style="margin-top:12px;text-align:center" class="small muted">¬© LeeNDXloud ‚Äî Join the loudest music web3 community</div>
    </div>
  `;
  const cr = $('#homeCreators'); cr.innerHTML=''; for(let i=0;i<6;i++){ const el=document.createElement('div'); el.className='home-card'; el.innerHTML=`<div>Creator ${i+1}</div><div class="small muted" style="margin-top:6px">Followers ${Math.floor(Math.random()*50000)}</div>`; cr.appendChild(el); }
  const hb = $('#homeBeats'); hb.innerHTML=''; for(let i=0;i<6;i++){ const el=document.createElement('div'); el.className='home-card'; el.innerHTML=`<div>Beat ${i+1}</div><div class="small muted" style="margin-top:6px">${(Math.random()*2).toFixed(2)} XLM</div>`; hb.appendChild(el); }
  const nf = $('#homeNFTs'); nf.innerHTML=''; for(let i=0;i<6;i++){ const el=document.createElement('div'); el.className='home-card'; el.innerHTML=`<div>NFT #${i+101}</div><div class="small muted" style="margin-top:6px">Creator ${i%6}</div>`; nf.appendChild(el); }
  updateHomeStats();
}
function renderDashboard(){
  app.view='dashboard';
  const main = $('#mainView');
  const mockBalance = (Math.random()*40 + 5).toFixed(3);
  main.innerHTML = `
    <section class="dashboard-page">
      <div class="dash-top">
        <div>
          <h3>Dashboard</h3>
          <div class="small muted">Wallet: ${app.user?.wallet?.slice?.(0,10) || 'Not connected'}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="balance-card">
            <div style="font-size:18px;font-weight:900">${mockBalance} XLM</div>
            <div class="small">Balance</div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;background:var(--panel);padding:10px;border-radius:12px;border:1px solid var(--glass-border)">
        <div class="small muted">Top coins</div>
        <div id="dashCoins" style="display:flex;gap:8px;overflow:auto;margin-top:8px"></div>
      </div>

      <div class="chart-wrap">
        <canvas id="pnlChart" width="800" height="220" style="width:100%;height:180px;"></canvas>
        <div class="small muted" style="margin-top:8px">PNL (simulated real-time)</div>
      </div>

      <div class="stat-grid">
        <div class="stat-card"><strong>Total Earnings</strong><div class="small muted"> ${ (Math.random()*200).toFixed(2) } XLM</div></div>
        <div class="stat-card"><strong>Gifts Received</strong><div class="small muted">${Math.floor(Math.random()*120)}</div></div>
        <div class="stat-card"><strong>Sales Volume</strong><div class="small muted">${ (Math.random()*300).toFixed(2) } XLM</div></div>
        <div class="stat-card"><strong>Engagement Points</strong><div class="small muted">${ Math.floor(Math.random()*10000) }</div></div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn" onclick="toast('Deposit initiated')">Deposit</button>
        <button class="btn" onclick="toast('Withdraw initiated')">Withdraw</button>
      </div>

      <div style="margin-top:12px">
        <strong>Connected Wallet Balances</strong>
        <div id="connectedBalances" style="margin-top:8px" class="small muted">Not connected</div>
      </div>
    </section>
  `;
  const row = $('#dashCoins'); row.innerHTML=''; app.coinsOrder.forEach(id=>{
    const sym = app.coinSymbols[id] || id.toUpperCase();
    const price = app.prices[id];
    const chg = app.prices[id+'chg'];
    const d = document.createElement('div'); d.className='coin-pill'; d.innerHTML = `<div style="font-weight:800">${sym}</div><div class="small muted">${price?formatUSD(price):'‚Äî'} ${chg!==undefined? `<span style="color:${chg>=0?'#16a34a':'#ef4444'}"> ${(chg>=0?'+':'')+chg.toFixed(2)}%</span>`: ''}</div>`;
    row.appendChild(d);
  });
  initPNLChart();
  refreshConnectedBalances();
}

/* =========================
   CoinGecko Live prices
   ========================= */
async function fetchLivePrices(){
  try{
    const ids = app.coinsOrder.join(',');
    const url = `https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&ids=${ids}&order=market_cap_desc&per_page=100&page=1&sparkline=false&price_change_percentage=24h`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('Price fetch failed');
    const data = await res.json();
    data.forEach(c=>{
      app.prices[c.id] = c.current_price;
      app.prices[c.id+'chg'] = c.price_change_percentage_24h;
    });
    updateTickerUI();
  }catch(e){ console.warn('coingecko', e); }
}
function updateTickerUI(){
  const tickRow = $('#tickRow'); tickRow.innerHTML='';
  app.coinsOrder.forEach(id=>{
    const sym = app.coinSymbols[id] || id.toUpperCase();
    const price = app.prices[id];
    const chg = app.prices[id+'chg'];
    const pill = document.createElement('div'); pill.className='coin-pill';
    pill.innerHTML = `<div style="font-weight:800">${sym}</div><div class="small muted">${ price ? formatUSD(price) : '‚Äî'} ${ (chg !== undefined) ? `<span style="color:${chg>=0?'#16a34a':'#ef4444'}">${(chg>=0?'+':'')+chg.toFixed(2)}%</span>` : ''}</div>`;
    tickRow.appendChild(pill);
  });
  const xlm = app.prices['stellar'] || 0;
  const btc = app.prices['bitcoin'] || 0;
  $('#priceTicker').innerText = `XLM ${xlm? xlm.toFixed(4) : '‚Äî'} ‚Ä¢ BTC ${btc? Math.round(btc) : '‚Äî'}`;
  if(app.view==='home') updateHomeStats();
  if(app.view==='dashboard') {
    const dashCoins = $('#dashCoins');
    if(dashCoins){ dashCoins.querySelectorAll('.coin-pill').forEach((el, idx)=>{ const id = app.coinsOrder[idx]; const v = app.prices[id]; const ch = app.prices[id+'chg']; el.innerHTML = `<div style="font-weight:800">${app.coinSymbols[id]}</div><div class="small muted">${v?formatUSD(v):'‚Äî'} ${ch!==undefined? `<span style="color:${ch>=0?'#16a34a':'#ef4444'}"> ${(ch>=0?'+':'')+ch.toFixed(2)}%</span>`: ''}</div>`; }); }
  }
}
function updateHomeStats(){ const hs = $('#homeStats'); if(!hs) return; hs.innerHTML=''; app.coinsOrder.forEach(id=>{ const s = app.coinSymbols[id]; const v=app.prices[id]; const ch=app.prices[id+'chg']; const pill=document.createElement('div'); pill.className='coin-pill'; pill.innerHTML=`<div style="font-weight:800">${s}</div><div class="small muted">${ v ? formatUSD(v) : '‚Äî' } ${ ch !== undefined ? `<small style="color:${ch>=0?'#16a34a':'#ef4444'}">${(ch>=0?'+':'')+ch.toFixed(2)}%</small>` : ''}</div>`; hs.appendChild(pill); }); }
fetchLivePrices(); setInterval(fetchLivePrices,15000);

/* =========================
   Modal system (create, player, wallet, sessions, login, register, progress)
   ========================= */
const modalBg = $('#modalBg'), modal = $('#modal');
function openModal(kind, id){
  modalBg.style.display='flex';
  switch(kind){
    case 'create': modal.innerHTML = mkCreateModal(); break;
    case 'player': modal.innerHTML = mkPlayerModal(id); break;
    case 'mint': modal.innerHTML = mkMintModal(); break;
    case 'buy': modal.innerHTML = mkBuyModal(); break;
    case 'wallet': modal.innerHTML = mkWalletModal(); break;
    case 'p2p': modal.innerHTML = mkP2PModal(); break;
    case 'settings': modal.innerHTML = mkSettingsModal(); break;
    case 'activities': modal.innerHTML = mkActivitiesModal(); break;
    case 'market': modal.innerHTML = mkMarketModal(); break;
    case 'sessions': modal.innerHTML = mkSessionsModal(); break;
    case 'login': modal.innerHTML = mkLoginModal(); break;
    case 'register': modal.innerHTML = mkRegisterModal(); break;
    case 'reset': modal.innerHTML = mkResetModal(); break;
    case 'progress': modal.innerHTML = `<div class="close-x" onclick="closeModal()">√ó</div><h3>Working‚Ä¶</h3>`; break;
    default: modal.innerHTML = '<h3>Coming soon</h3>';
  }
}
function closeModal(e){ if(e && e.target && e.target.id==='modalBg') return; modalBg.style.display='none'; }

/* Modal templates used elsewhere (create, player, etc) */
function mkCloseX(){ return `<div class="close-x" onclick="closeModal()">√ó</div>`; }
function mkCreateModal(){
  return `${mkCloseX()}<h3>Create Content</h3><div class="small muted">Upload exclusive music, set price in XLM, and optionally mint an NFT.</div><div style="margin-top:8px;display:grid;gap:8px"><input id="c_title" placeholder="Title (e.g. Midnight Freestyle)" /><select id="c_type"><option>Exclusive Music</option><option>Beat</option><option>Video</option><option>Photo</option><option>Article</option></select><input id="c_price" placeholder="Price in XLM (e.g. 1.5)" /><label><input type="checkbox" id="c_mint" /> Mint as NFT on Stellar</label><div style="display:flex;gap:8px"><button class="btn" onclick="publishContent()">Publish</button><button class="chip" onclick="closeModal()">Cancel</button></div><div class="small muted" style="margin-top:6px">Or upload a recording directly from the Studio (Saved Sessions ‚Üí Post).</div></div>`;
}
function mkPlayerModal(id){ const p = app.feed.find(x=>x.id===id) || {}; return `${mkCloseX()}<h3>${p.title || 'Player'}</h3><div class="small muted">By ${p.user || 'Unknown'}</div><div class="media" style="height:220px;margin-top:8px"><img src="${p.image||''}" /></div><div style="display:flex;gap:8px;margin-top:10px"><button class="btn" onclick="like('${id}')">‚ù§ Like</button><button class="chip" onclick="downloadMedia('${p.image||''}')">Download</button><button class="chip" onclick="closeModal()">Close</button></div>`; }
function mkMintModal(){ return `${mkCloseX()}<h3>Mint NFT</h3><div class="small muted">To mint on Stellar, connect a wallet and use the mint flow.</div><input id="mint_name" placeholder="Token name (e.g. Beat#1)" /><input id="mint_royalty" placeholder="Royalty % (e.g. 5)" /><div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="doMint()">Mint</button><button class="chip" onclick="closeModal()">Cancel</button></div>`; }
function mkBuyModal(){ return `${mkCloseX()}<h3>Buy / Sell</h3><div class="small muted">Place an order in XLM.</div><input id="order_amt" placeholder="Amount in XLM" /><select id="order_side"><option value="buy">Buy</option><option value="sell">Sell</option></select><div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="placeOrder()">Place Order</button><button class="chip" onclick="closeModal()">Cancel</button></div>`; }
function mkP2PModal(){ return `${mkCloseX()}<h3>P2P Exchange</h3><div class="small muted">Post orders to trade other coins to XLM.</div><div style="margin-top:8px"><button class="btn" onclick="postP2P()">Post Order</button><button class="chip" onclick="closeModal()">Cancel</button></div>`; }
function mkSettingsModal(){ return `${mkCloseX()}<h3>Settings</h3><div class="small muted">Profile & account options</div><input id="profile_name" placeholder="Full name" /><input id="profile_user" placeholder="Username" /><input id="profile_email" placeholder="Email" /><div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="saveProfile()">Save</button><button class="chip" onclick="closeModal()">Cancel</button></div>`; }
function mkActivitiesModal(){ return `${mkCloseX()}<h3>Activities</h3><div class="small muted">Transactions, gifting, deposits & withdrawals.</div><div style="margin-top:8px"><button class="btn" onclick="closeModal()">Close</button></div>`; }
function mkMarketModal(){ return `${mkCloseX()}<h3>Marketplace</h3><div class="small muted">Explore exclusive content for sale.</div><div style="margin-top:8px"><button class="btn" onclick="closeModal()">Close</button></div>`; }
function mkSessionsModal(){ return `${mkCloseX()}<h3>Saved Sessions</h3><div class="small muted">Play or post your recordings.</div><div style="display:grid;gap:8px;margin-top:8px">${app.savedSessionsLocal.map(s=>`<div style="display:flex;gap:8px;align-items:center"><div style="flex:1">${new Date(s.ts && s.ts.toDate ? s.ts.toDate() : s.ts).toLocaleString()}</div><div style="display:flex;gap:6px"><button class="chip" onclick="playSession('${s.id}')">Play</button><button class="btn" onclick="postSession('${s.id}')">Post</button></div></div>`).join('')}<div style="display:flex;gap:8px;margin-top:8px"><button class="chip" onclick="closeModal()">Cancel</button></div></div>`; }

/* modal handlers */
function doMint(){ closeModal(); toast('Mint requested'); }
function placeOrder(){ closeModal(); toast('Order placed'); }
function postP2P(){ closeModal(); toast('P2P order posted'); }
function saveProfile(){ closeModal(); toast('Profile saved'); }

/* =========================
   Studio recorder (MediaRecorder) + flows
   ========================= */
let mediaRecorder = null, chunks = [], recording=false, recordStart=0;
const preview = $('#studioPreview'), sessionTimer = $('#sessionTimer');
async function initRecorder(){
  if(mediaRecorder) return;
  try{
    const s = await navigator.mediaDevices.getUserMedia({ audio:true });
    mediaRecorder = new MediaRecorder(s);
    mediaRecorder.ondataavailable = e => chunks.push(e.data);
    mediaRecorder.onstop = ()=> {
      const blob = new Blob(chunks, { type:'audio/webm' });
      chunks=[];
      app.lastRecordingBlob = blob;
      const url = URL.createObjectURL(blob);
      preview.src = url; preview.style.display='block'; $('#saveTake').style.display='inline-block';
      toast('Recording ready for preview');
    };
  }catch(e){ console.warn('mic', e); toast('Microphone access denied'); }
}
$('#recBtn').addEventListener('click', async ()=>{
  if(!mediaRecorder) await initRecorder();
  if(!mediaRecorder) return;
  if(!recording){ chunks=[]; mediaRecorder.start(); recording=true; recordStart=Date.now(); $('#recBtn').innerText='STOP'; tickTimer(); toast('Recording...'); }
  else { mediaRecorder.stop(); recording=false; $('#recBtn').innerText='REC'; sessionTimer.innerText='0:00'; }
});
function tickTimer(){ if(!recording) return; const s = Math.floor((Date.now()-recordStart)/1000); sessionTimer.innerText = Math.floor(s/60)+':'+String(s%60).padStart(2,'0'); setTimeout(tickTimer,500); }
$('#playLast').addEventListener('click', ()=>{ if(preview.src){ preview.play(); toast('Playing last'); } else toast('No recording'); });
$('#saveTake').addEventListener('click', async ()=>{ if(!app.lastRecordingBlob) return toast('No recording'); if(!app.currentUser) return toast('Sign in to save'); await uploadRecordingAndPost(app.lastRecordingBlob, 'Recorded from Studio'); $('#saveTake').style.display='none'; });

function renderSessions(){ const row = $('#sessionsRow'); row.innerHTML=''; app.savedSessionsLocal.forEach(s=>{ const el=document.createElement('div'); el.className='session-pill'; const ts = s.ts && s.ts.toDate ? s.ts.toDate().toLocaleTimeString() : (new Date(s.ts)).toLocaleTimeString(); el.innerHTML=`<div style="display:flex;gap:8px;align-items:center"><div style="flex:1">${ts}</div><div style="display:flex;gap:6px"><button class="chip" onclick="playSession('${s.id}')">Play</button><button class="chip" onclick="postSession('${s.id}')">Post</button></div></div>`; row.appendChild(el); }); }
function playSession(id){ const s = app.savedSessionsLocal.find(x=>x.id===id); if(!s) return toast('Missing'); preview.src = s.url || s.downloadURL; preview.style.display='block'; preview.play(); toast('Playing saved'); }
async function postSession(id){ const s = app.savedSessionsLocal.find(x=>x.id===id); if(!s) return toast('Missing'); if(!app.currentUser) return toast('Sign in to post'); const postDoc={ user: app.currentUser.displayName||app.currentUser.email||'User', title:'Recorded Session ‚Ä¢ '+(s.ts&&s.ts.toDate? s.ts.toDate().toLocaleString(): new Date(s.ts).toLocaleString()), image:`https://picsum.photos/seed/${Math.floor(Math.random()*99999)}/800/640`, audio: s.url||s.downloadURL, likes:0, xlm:0, minted:false, uid: app.currentUser.uid, ts: firebase.firestore.FieldValue.serverTimestamp() }; await db.collection('posts').add(postDoc); toast('Posted recording to feed'); }

/* pads audio (simple fun) */
const Actx = window.AudioContext || window.webkitAudioContext;
const actx = new Actx();
function playTone(freq,type='sine',dur=0.14){ const o=actx.createOscillator(), g=actx.createGain(); o.type=type; o.frequency.value=freq; g.gain.setValueAtTime(0.0001,actx.currentTime); g.gain.exponentialRampToValueAtTime(0.45,actx.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001,actx.currentTime+dur); o.connect(g); g.connect(actx.destination); o.start(); o.stop(actx.currentTime+dur+0.02); }
$$('.pad').forEach(p => p.addEventListener('click', ()=>{ const name=p.dataset.pad; if(name==='kick') playTone(80,'sine',0.18); else if(name==='snare'){ playTone(180,'square',0.12); playTone(400,'sawtooth',0.06);} else if(name==='hihat') playTone(1200,'triangle',0.04); else playTone(600,'sine',0.14); toast('Pad: '+name); }));

/* =========================
   PNL Chart
   ========================= */
let pnlCtx=null, pnlData=[], pnlMax=80, pnlInterval=null;
function initPNLChart(){ const c=document.getElementById('pnlChart'); if(!c) return; pnlCtx=c.getContext('2d'); pnlData=[]; let v=0; for(let i=0;i<pnlMax;i++){ v+=(Math.random()-0.5)*2; pnlData.push(v);} if(pnlInterval) clearInterval(pnlInterval); pnlInterval=setInterval(()=>{ stepPNL(); drawPNL(c,pnlCtx); },600); drawPNL(c,pnlCtx); }
function stepPNL(){ const last = pnlData[pnlData.length-1]||0; const x = app.prices['stellar']||0.12; const drift = (Math.random()-0.5)*(x*5); pnlData.push(last+drift); if(pnlData.length>pnlMax) pnlData.shift(); }
function drawPNL(canvas,ctx){ const w=canvas.width=canvas.clientWidth*devicePixelRatio; const h=canvas.height=canvas.clientHeight*devicePixelRatio; ctx.clearRect(0,0,w,h); const min=Math.min(...pnlData), max=Math.max(...pnlData), range=Math.max((max-min),0.0001); const g=ctx.createLinearGradient(0,0,0,h); g.addColorStop(0,'rgba(99,102,241,0.12)'); g.addColorStop(1,'rgba(14,165,233,0.02)'); ctx.fillStyle=g; ctx.beginPath(); pnlData.forEach((v,i)=>{ const x=(i/(pnlData.length-1))*w; const y=h-((v-min)/range)*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.lineTo(w,h); ctx.lineTo(0,h); ctx.closePath(); ctx.fill(); ctx.beginPath(); ctx.lineWidth=2*devicePixelRatio; ctx.strokeStyle='rgba(99,102,241,0.95)'; pnlData.forEach((v,i)=>{ const x=(i/(pnlData.length-1))*w; const y=h-((v-min)/range)*h; if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke(); const cur = pnlData[pnlData.length-1].toFixed(2); ctx.fillStyle='rgba(0,0,0,0.65)'; ctx.font = `${12 * devicePixelRatio}px sans-serif`; ctx.fillText('PNL: ' + cur, 8 * devicePixelRatio, 16 * devicePixelRatio); }

/* =========================
   Helpers & Boot
   ========================= */
function formatUSD(n){ if(!n && n!==0) return '‚Äî'; if(n>=1000) return '$' + Number(n).toLocaleString(undefined,{maximumFractionDigits:0}); if(n>=1) return '$' + n.toFixed(2); return '$' + n.toFixed(6); }
function capitalize(s){ if(!s) return ''; return s.charAt(0).toUpperCase()+s.slice(1); }

function showHome(){ renderHome(); }
function showDashboard(){ renderDashboard(); }
renderFeed(); renderSessions(); fetchLivePrices(); setInterval(fetchLivePrices,15000);
initPNLChart();

/* keyboard close */
document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

/* theme toggle */
$('#uniqueThemeToggle').addEventListener('click', ()=>{ const cur=document.body.getAttribute('data-theme')||'light'; const next = cur==='light'?'dark':'light'; document.body.setAttribute('data-theme', next); toast('Theme: '+(next==='dark'?'Dark':'Light')); });

/* Bind top create & wallet & login */
document.getElementById('createBtnTop').addEventListener('click', ()=> openModal('create'));
document.getElementById('connectWalletTop').addEventListener('click', ()=> openModal('wallet'));
$('#loginBtn').addEventListener('click', ()=> openModal('login'));

/* Try auto-reconnect last wallet type */
tryReconnectEVM();
tryReconnectFreighter();

/* Expose some functions for debugging */
window.uploadRecordingAndPost = uploadRecordingAndPost;
window.connectEVMWallet = connectEVMWallet;
window.connectFreighter = connectFreighter;
window.disconnectWallet = disconnectWallet;

</script>
</body>
</html>
